<cfsilent>
	<cfimport taglib="../layout" prefix="RIMSS"/>
	<cfset dropDownUtilities = application.objectFactory.create("DropDownDao") />
	<cfset dbUtils = application.objectFactory.create("DBUtils") />
	<cfset utils = new cfc.utils.utilities()/>
    <cfset spareNouns = dropDownUtilities.getNouns(program = APPLICATION.sessionmanager.getProgramSetting()) />
    <cfset spareStatusList = dropDownUtilities.getProgramPartStatus(UCASE(TRIM(APPLICATION.sessionmanager.getProgramSetting()))) />
	<cfset spareLocList = dropDownUtilities.getSpareLocations(UCASE(TRIM(APPLICATION.sessionmanager.getProgramSetting()))) />
	<cfset programLookup = application.sessionManager.getProgramSetting() />
	<cfset programIdLookup = application.sessionManager.getProgramIdSetting() />
	<cfset sysLookup = dbUtils.getSysIdByProgram(programLookup)/>	   
	<cfset getSoftwareList = dbUtils.getSoftwareBySysId(sysLookup)/> 
	
	<cfsetting showdebugoutput="false" >
	
</cfsilent>


<RIMSS:layout section="spares">
    <RIMSS:subLayout subsection="#APPLICATION.sessionManager.getSubsection()#"/>
	<style>
		.disable{
			opacity:0.5;
			-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
			color:gray;
		}
		
		#softwareTable {
		    height: 100px;
		    
		    display: block;
		    
		    width: 100%;
		    overflow: auto;
		}	
		
		#btnUpdate{
			display: none;
		}		
		
		.highlightrow td {
			color: black;
		    background-color: yellow;
		}
		
		#remarks {
			width: 400px; 
		}
		
		td {
		    padding:.2em .5em
		}	
		
	</style>
	<script src="../layout/js/spares.js"></script>
	<script>
        try {
            $(document).ready(function(){
            	
                //setupEditHighlight();
                setupHighlight();

				
                $('#btnSearch').on("click",function(){
                    $(this).closest("form").setActionMethod("list.spares","forward");
					$(this).closest("form").submit();
                });
				
				/*$('#spareNouns').on("change keyup",function(){
                    $(this).closest("form").setActionMethod("list.spares","forward");
					$(this).closest("form").submit();
                });*/
				
				$('#btnAdd').on("click",function(){
                    $(this).closest("form").setActionMethod("add.spare","forward");
                });
                
				$('#btnUpdate').on("click",function(){
					var path = "<CFOUTPUT>#application.rootpath#</CFOUTPUT>";
					
                    window.location.href = path + "/acts/spares/controller.cfm?action=updateSpares";
                });                                            
				
				$('.deleteIcon').on("click",function(event){
                    if (removeConfirmation()) {
                        $(this).closest("form").setActionMethod("delete.spare", "forward");
                    }else{
						event.preventDefault();
						return false;
						
					}
                });
				
				$("input[name='check']").change(function() {
					var id = $(this).closest(".rootNode").attr("id");
				
					if($(this).attr("checked")){ 
						//enable everything in the row including embedded form elements
						$(this).closest("tr").children().children().removeAttr("disabled");
						$(this).closest("tr").children().children().children().removeAttr("disabled");
						$(this).closest("tr").children().children().children().children().children().children().removeAttr("disabled");	
						$(this).closest("tr").children().children().children().children().children().children().children().removeAttr("disabled");		
						$(this).closest("tr").toggleClass('highlightrow');
						
						document.getElementById("btnUpdate").style.display="block";
							
						$("#"+id).find(".sw2").show();
						$("#"+id).find(".sw1").hide();
						
					}
					else {				
						
						//make all disabled
						$(this).closest("tr").find("[disabled!=true]").attr("disabled",true);
						$(this).closest("tr").toggleClass('highlightrow');
						
						//but enable the check box to edit
						$(this).removeAttr("disabled") 	
						checkChecked('searchSparesResults');
						
						$("#"+id).find(".sw1").show();
						$("#"+id).find(".sw2").hide();
						
						} ;
					});
						
					function checkChecked(formname) {
						// check to see if any edit checkboxes are checked
						// to hide/show the Mass Update button
					    var anyBoxesChecked = false;
					    $('#' + formname + ' #check').each(function() {
					        if ($(this).is(":checked")) {
					            anyBoxesChecked = true;
					        }
					    });
					 
					    if (anyBoxesChecked == false) {
					      document.getElementById("btnUpdate").style.display="none";
					      return false;
					    } 
					}											
						
				
                $('#dtSearch').on('keyup',function(e){
                    dt.fnFilter($(this).val());
                   });
                
                //Add Data Table
                var dt = $('#sparesTable').dataTable({ 
                      "bFilter": true,
                      "sDom":"t"
               });

               modifyDTColumns();
			   
            });                                   
			
        }catch(err){}

    </script>
	
	
	<cfoutput>
       <div class="message #msgStatus#">#msg#</div>
       
    </cfoutput>
    <div class="headerContent">
        <div class="headerTitle">List Spares</div>
    </div>
    
	<div class="font12 mainContent">
        <form id="searchSpares" name="searchSpares" method="post" action="index.cfm?action=list.spares">
            <table class="two_column_table" cellpadding="0px" cellspacing="0px">
                <tbody>
                    <tr>
                        <td class="column">
                            <div class="columnContent" style="text-align:center">
                                <div class="formField">
                                    <label class="font10" id="asset_id_label">Noun:</label> 
                                    <cfoutput>
                                        <select name="spareNouns" id="spareNouns" >
                                        	<option value=""></option>
											<cfif isDefined("spareNouns") and isQuery(spareNouns)>
												<cfloop query="spareNouns">
													<option <cfif Structkeyexists(form,"spareNouns") and UCASE(TRIM(form.spareNouns)) eq UCASE(TRIM(NOUN))>selected="selected"</cfif>  value="#HTMLEditFormat(noun)#">#HTMLEditFormat(noun)#</option>
												</cfloop>
											</cfif>
											
                                        </select>
                                    </cfoutput>
								</div>
                            </div>
                        </td>    
                    </tr>
                    <tr>
                        <td class="column" colspan="2">
                            <div class="columnContent">
                                <div class="formField button_container">
                                    <input type="submit" value="ADD" name="btnAdd" id="btnAdd" />
                                    <input type="submit" value="SEARCH" name="btnSearch" id="btnSearch" />
                                    
                                </div>                                    
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
	<cfif isDefined("rc.qSpares")>			
		<div class="mainContent">  
			<cfif rc.qSpares.count()>
			<form id="searchSparesResults" name="searchSparesResults" method="post"  action="controller.cfm?action=updateSpares"><input type="submit" value="MASS UPDATE" name="btnUpdate" id="btnUpdate" />
			
			   <table class="globalTable sticky-headers" id="sparesTable">
			         <thead>
			         	<tr>
							<th colspan="13" class="filter">
								<cfoutput><cfif rc.qSpares.count() gt 1> <div style="float:left">Spares Count: #rc.qSpares.count()#</div></cfif></cfoutput>
                              <div>Filter Results: <input type="text" id="dtSearch"/></div>      
                            </th>
                        </tr>
			         	<tr>
			         		<th class="noSort">&nbsp;</th>
			         		<th class="noSort">&nbsp;</th>
							<th>Spare Noun</th>
							<th>Spare Part Number</th>
							<th>Spare Serial Number</th>
							<th>Status</th>
							<th>Warranty Exp</th>
							<th>Location</th>
							<th>Depot</th>
							<th>Software Number/Title</th>
							<th>Remarks</th>
							<th class="noSort">&nbsp;</th>
							<th class="noSort ">&nbsp;</th>
			         	</tr>
						
			         </thead>
				   <tbody> 	     	
			       <cfoutput>
				   <cfloop condition="#rc.qSpares.next()#">
				   	   
				   	   <cfset swQry = #dbUtils.getSoftwareByAssetId(val(rc.qSpares.getAssetId()))# />				   	   
				   	   
				   	   <cfset warrantyDate = isDate(rc.qSpares.getMfgDate()) ? UCASE(TRIM(DateFormat(rc.qSpares.getMfgDate(),"dd-mmm-yyyy"))) : ""/>    
				        <tr id="node_#rc.qSpares.getEncryptedAssetId()#" data-id="node_#rc.qSpares.getEncryptedAssetId()#" class="<cfif rc.qSpares.getCursor() mod 2> odd <cfelse> even </cfif> <cfif rc.qSpares.getIsOrdered() EQ 'Y'>disable</cfif> rootNode">
				        	
				        	<td><cfif rc.qSpares.getIsOrdered() EQ 'N'><input type="checkbox" id="check" name="check"></cfif><input disabled="true" name="assetID" type="hidden" value="#rc.qSpares.getAssetId()#"></td>
				        	
                            <td class="edit editIcon"><cfif rc.qSpares.getIsOrdered() EQ 'N'><a href="index.cfm?action=edit.spare&spareAsset=#rc.qSpares.getEncryptedAssetId()#"></a></cfif></td>
                            <td>#HTMLEditFormat(trim(rc.qSpares.getNoun()))#</td>
                            <td>#HTMLEditFormat(trim(rc.qSpares.getPartNo()))#</td>
                            <td>#HTMLEditFormat(trim(rc.qSpares.getSerNo()))#</td>
                            <td>
								<select class="disabled" disabled="true" name="spareStatus" id="spareStatus">
									<cfif isDefined("spareStatusList") and isArray(spareStatusList)>
									    <cfloop array="#spareStatusList#" index="curSpare">
											<cfif Arraylen(curSpare) gte 2>
											  <option value="#curspare[1]#" <cfif trim(rc.qSpares.getStatus()) eq trim(curSpare[2])>selected="selected"</cfif>>#curSpare[2]#</option>
											</cfif>
										</cfloop>
									</cfif>
								</select>   
							</td>                         
							<td>#HTMLEditFormat(trim(warrantyDate))#</td>
                            <td>
                            	<select class="disabled" disabled="true" name="spareLocation" id="spareLocation">
                            		<cfif isDefined("spareLocList") and isArray(spareLocList)>
                            			<cfloop array="#spareLocList#" index="curSpare">
                                            <cfif Arraylen(curSpare) gte 2>
                                              <option value="#curSpare[1]#" <cfif trim(rc.qSpares.getlocIDC()) eq trim(curSpare[1])>selected="selected"</cfif>>#curSpare[2]#</option>
                                            </cfif>                            				
                            			</cfloop>
                            		</cfif>
                            		<!---<p title="Site: #HTMLEditFormat(trim(rc.qSpares.getCurrentLoc()))# Unit: #HTMLEditFormat(trim(rc.qSpares.getCurrentUnit()))#">#HTMLEditFormat(trim(rc.qSpares.getCurrentLoc()))#</p>--->
                            	</select>
                            </td>
							<td>#HTMLEditFormat(trim(rc.qSpares.getDepotLoc()))#</td>
							<td width="30%">
									  <div class="sw1">
										<ul>
									  	<cfloop query="swQry">
									  		<li>#HTMLEditFormat(SW_TITLE)# - #HTMLEditFormat(SW_NUMBER)#</li>
									  	</cfloop>
									  	</ul>
									  </div>
									  <div class="sw2" style="display:none">
	                                	  <cfset swIDs = ValueList(swQry.sw_id)>
	                                      <cfif getSoftwareList.recordcount GT 0>
	                                         <table class="globaltable" name="softwareTable" id="softwareTable">
	                                            <thead>
	                                                <tr>
	                                                    <th>Number</th>
	                                                    <th>Title</th>
	                                                    <th class="noSort ">&nbsp;</th>
	                                                </tr>
	                                            </thead>
	                                            <tbody>
	                                                <cfloop  query="getSoftwareList" >
	                                                    <cfoutput>
	                                                        <tr>
	                                                            <td>#HTMLEditFormat(getSoftwareList.SW_NUMBER)#</td>
	                                                            <td>#HTMLEditFormat(getSoftwareList.SW_TITLE)#</td>
	                                                            <td><input id="swCheck" disabled="true" name="swCheck" value="#HTMLEditFormat(rc.qSpares.getAssetId())#$#HTMLEditFormat(getSoftwareList.sw_id)#" type="checkbox" <cfif ListFindNocase(swIDs,getSoftwareList.sw_id)>checked="checked"</cfif>></input></td>
	
	                                                        </tr>
	                                                    </cfoutput>
	                                                </cfloop>
	                                            </tbody>
	                                        </table>
	                                      </cfif>                                        	
                                	 </div>
                                </div>                                       							
							</td>
							<td>	
								<input class="disabled" name="remarks" id="remarks" disabled="true" type="text" title="#HTMLEditFormat(trim(rc.qSpares.getRemarks()))#" value="#HTMLEditFormat(trim(rc.qSpares.getRemarks()))#">		
							</td>
							<td class="add addIcon"><cfif rc.qSpares.getIsOrdered() EQ 'N'><a href="index.cfm?action=add.like.spare&spareAsset=#rc.qSpares.getEncryptedAssetId()#"></a></cfif></td>
							<td class="delete deleteIcon "><cfif rc.qSpares.getIsOrdered() EQ 'N'><a href="index.cfm?action=delete.spare&spareAsset=#rc.qSpares.getEncryptedAssetId()#"></a></cfif></td>
                        </tr>	   
				   </cfloop>
				   </cfoutput>
				   </tbody>
		   	   </table>
			   </form>
			<cfelse>
                <div class="global_notice_msg">No Data Found</div>   
			</cfif>
		</div>	

	</cfif>
</RIMSS:layout>