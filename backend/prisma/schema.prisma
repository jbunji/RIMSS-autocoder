// RIMSS Database Schema
// RAMPOD Inventory & Maintenance System Software

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Core Tables
// ============================================================================

model Program {
  pgm_id      Int       @id @default(autoincrement())
  pgm_cd      String    @unique @db.VarChar(10)
  pgm_name    String    @db.VarChar(100)
  pgm_desc    String?   @db.Text
  active      Boolean   @default(true)
  ins_by      String?   @db.VarChar(50)
  ins_date    DateTime  @default(now())
  chg_by      String?   @db.VarChar(50)
  chg_date    DateTime?

  // Relations
  userPrograms     UserProgram[]
  partLists        PartList[]
  cfgSets          CfgSet[]
  sorties          Sortie[]
  tctos            Tcto[]
  notifications    Notification[]
  spares           Spare[]
  partsOrders      PartsOrder[] @relation("PartsOrderLocation")
  locSets          LocSet[]
  programLocations ProgramLocation[]

  @@map("program")
}

model User {
  user_id       Int       @id @default(autoincrement())
  username      String    @unique @db.VarChar(50)
  password_hash String    @db.VarChar(255)
  email         String    @unique @db.VarChar(100)
  first_name    String    @db.VarChar(50)
  last_name     String    @db.VarChar(50)
  role          UserRole  @default(VIEWER)
  active        Boolean   @default(true)
  last_login    DateTime?
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  userPrograms  UserProgram[]
  userLocations UserLocation[]
  auditLogs     AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DEPOT_MANAGER
  FIELD_TECHNICIAN
  VIEWER
}

model UserProgram {
  user_program_id Int      @id @default(autoincrement())
  user_id         Int
  pgm_id          Int
  is_default      Boolean  @default(false)
  ins_by          String?  @db.VarChar(50)
  ins_date        DateTime @default(now())

  // Relations
  user    User    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  program Program @relation(fields: [pgm_id], references: [pgm_id])

  @@unique([user_id, pgm_id])
  @@map("user_program")
}

model UserLocation {
  user_location_id Int      @id @default(autoincrement())
  user_id          Int
  loc_id           Int
  is_default       Boolean  @default(false)
  ins_by           String?  @db.VarChar(50)
  ins_date         DateTime @default(now())

  // Relations
  user     User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  location Location @relation(fields: [loc_id], references: [loc_id])

  @@unique([user_id, loc_id])
  @@map("user_location")
}

model ProgramLocation {
  program_location_id Int       @id @default(autoincrement())
  pgm_id              Int
  loc_id              Int
  active              Boolean   @default(true)
  ins_by              String?   @db.VarChar(50)
  ins_date            DateTime  @default(now())
  chg_by              String?   @db.VarChar(50)
  chg_date            DateTime?

  // Relations
  program  Program  @relation(fields: [pgm_id], references: [pgm_id], onDelete: Cascade)
  location Location @relation(fields: [loc_id], references: [loc_id], onDelete: Cascade)

  @@unique([pgm_id, loc_id])
  @@map("program_location")
}

model Code {
  code_id     Int       @id @default(autoincrement())
  code_type   String    @db.VarChar(50)
  code_value  String    @db.VarChar(50)
  description String?   @db.VarChar(255)
  active      Boolean   @default(true)
  sort_order  Int       @default(0)
  ins_by      String?   @db.VarChar(50)
  ins_date    DateTime  @default(now())
  chg_by      String?   @db.VarChar(50)
  chg_date    DateTime?

  // Relations
  codeGroups CodeGroup[]

  @@unique([code_type, code_value])
  @@map("code")
}

model CodeGroup {
  cdgrp_id    Int      @id @default(autoincrement())
  group_cd    String   @db.VarChar(50)
  code_id     Int
  sort_order  Int      @default(0)
  description String?  @db.VarChar(255)
  ins_by      String?  @db.VarChar(50)
  ins_date    DateTime @default(now())

  // Relations
  code Code @relation(fields: [code_id], references: [code_id])

  @@map("code_group")
}

model Location {
  loc_id       Int       @id @default(autoincrement())
  majcom_cd    String?   @db.VarChar(10)
  site_cd      String?   @db.VarChar(20)
  unit_cd      String?   @db.VarChar(20)
  squad_cd     String?   @db.VarChar(20)
  description  String?   @db.VarChar(255)
  geoloc       String?   @db.VarChar(100)
  display_name String    @db.VarChar(100)
  old_loc_id   Int?
  active       Boolean   @default(true)
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())
  chg_by       String?   @db.VarChar(50)
  chg_date     DateTime?

  // Relations
  assetsAdmin      Asset[]           @relation("AdminLocation")
  assetsCustodial  Asset[]           @relation("CustodialLocation")
  events           Event[]
  sruOrders        SruOrder[]
  badActors        BadActor[]
  notifications    Notification[]
  spares           Spare[]
  partsOrders      PartsOrder[] @relation("PartsOrderLocation")
  userLocations    UserLocation[]
  locSets          LocSet[]
  programLocations ProgramLocation[]

  @@map("location")
}

// ============================================================================
// Part & Asset Tables
// ============================================================================

model PartList {
  partno_id  Int       @id @default(autoincrement())
  partno     String    @db.VarChar(50)
  pgm_id     Int
  sys_type   String?   @db.VarChar(20)
  noun       String?   @db.VarChar(100)
  nsn        String?   @db.VarChar(20)
  cage       String?   @db.VarChar(10)
  nha_id     Int?
  config     String?   @db.VarChar(50)
  unit_price Decimal?  @db.Decimal(12, 2)
  sn_tracked Boolean   @default(true)
  wuc_cd     String?   @db.VarChar(10)
  mds_cd     String?   @db.VarChar(10)
  version    String?   @db.VarChar(20)
  errc       String?   @db.VarChar(10)
  lsru_flag  Boolean   @default(false)
  loc_idr    Int?
  active     Boolean   @default(true)
  valid      Boolean   @default(false)
  val_by     String?   @db.VarChar(50)
  val_date   DateTime?
  ins_by     String?   @db.VarChar(50)
  ins_date   DateTime  @default(now())
  chg_by     String?   @db.VarChar(50)
  chg_date   DateTime?

  // Relations
  program    Program      @relation(fields: [pgm_id], references: [pgm_id])
  nha        PartList?    @relation("NhaRelation", fields: [nha_id], references: [partno_id])
  children   PartList[]   @relation("NhaRelation")
  assets     Asset[]
  cfgSets    CfgSet[]
  cfgListsP  CfgList[]    @relation("ParentPart")
  cfgListsC  CfgList[]    @relation("ChildPart")
  sruOrders  SruOrder[]
  laborParts LaborPart[]
  partsOrders PartsOrder[]
  substituteOrders PartsOrder[] @relation("SubstitutePart")

  @@unique([partno, pgm_id])
  @@map("part_list")
}

model Asset {
  asset_id      Int       @id @default(autoincrement())
  partno_id     Int
  serno         String    @db.VarChar(50)
  status_cd     String    @default("FMC") @db.VarChar(10)
  loc_ida       Int?
  loc_idc       Int?
  nha_asset_id  Int?
  cfg_set_id    Int?
  active        Boolean   @default(true)
  reportable    Boolean   @default(true)
  cfo_tracked   Boolean   @default(false)
  bad_actor     Boolean   @default(false)
  valid         Boolean   @default(false)
  val_by        String?   @db.VarChar(50)
  val_date      DateTime?
  uii           String?   @db.VarChar(50)
  etic          DateTime?
  lotno         String?   @db.VarChar(50)
  mfg_date      DateTime?
  accept_date   DateTime?
  next_ndi_date DateTime?
  deployed_date DateTime?
  tcn           String?   @db.VarChar(50)
  shipper       String?   @db.VarChar(50)
  ship_date     DateTime?
  recv_date     DateTime?
  eti           Decimal?  @db.Decimal(10, 2)
  eti_liate     Decimal?  @db.Decimal(10, 2)
  in_transit    Boolean   @default(false)
  tail_no       String?   @db.VarChar(20)
  remarks       String?   @db.Text
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  part         PartList         @relation(fields: [partno_id], references: [partno_id])
  adminLoc     Location?        @relation("AdminLocation", fields: [loc_ida], references: [loc_id])
  custodialLoc Location?        @relation("CustodialLocation", fields: [loc_idc], references: [loc_id])
  nhaAsset     Asset?           @relation("AssetNha", fields: [nha_asset_id], references: [asset_id])
  sraAssets    Asset[]          @relation("AssetNha")
  cfgSet       CfgSet?          @relation(fields: [cfg_set_id], references: [cfg_set_id])
  events       Event[]
  repairs      Repair[]
  labors       Labor[]
  laborParts   LaborPart[]
  inspections  AssetInspection[]
  meters       MeterHist[]
  softwareAssets SoftwareAsset[]
  sorties      Sortie[]
  tctoAssets   TctoAsset[]
  sruOrders    SruOrder[]

  @@unique([partno_id, serno])
  @@map("asset")
}

// ============================================================================
// Configuration Tables
// ============================================================================

model CfgSet {
  cfg_set_id  Int       @id @default(autoincrement())
  cfg_name    String    @db.VarChar(100)
  cfg_type    String?   @db.VarChar(20)
  pgm_id      Int
  partno_id   Int?
  description String?   @db.Text
  active      Boolean   @default(true)
  ins_by      String?   @db.VarChar(50)
  ins_date    DateTime  @default(now())
  chg_by      String?   @db.VarChar(50)
  chg_date    DateTime?

  // Relations
  program   Program     @relation(fields: [pgm_id], references: [pgm_id])
  part      PartList?   @relation(fields: [partno_id], references: [partno_id])
  cfgLists  CfgList[]
  assets    Asset[]
  cfgMeters CfgMeter[]

  @@map("cfg_set")
}

model CfgList {
  list_id    Int       @id @default(autoincrement())
  cfg_set_id Int
  partno_p   Int
  partno_c   Int
  sort_order Int       @default(0)
  qpa        Int       @default(1)
  active     Boolean   @default(true)
  ins_by     String?   @db.VarChar(50)
  ins_date   DateTime  @default(now())
  chg_by     String?   @db.VarChar(50)
  chg_date   DateTime?

  // Relations
  cfgSet     CfgSet   @relation(fields: [cfg_set_id], references: [cfg_set_id], onDelete: Cascade)
  parentPart PartList @relation("ParentPart", fields: [partno_p], references: [partno_id])
  childPart  PartList @relation("ChildPart", fields: [partno_c], references: [partno_id])

  @@map("cfg_list")
}

// ============================================================================
// Maintenance Tables
// ============================================================================

model Event {
  event_id    Int       @id @default(autoincrement())
  asset_id    Int
  loc_id      Int?
  job_no      String?   @db.VarChar(20)
  discrepancy String?   @db.Text
  start_job   DateTime?
  stop_job    DateTime?
  when_disc   String?   @db.VarChar(10)
  how_mal     String?   @db.VarChar(10)
  wuc_cd      String?   @db.VarChar(10)
  priority    String?   @db.VarChar(10)
  symbol      String?   @db.VarChar(10)
  event_type  String?   @db.VarChar(20)
  sortie_id   Int?
  source      String?   @db.VarChar(20)
  source_cat  String?   @db.VarChar(20)
  sent_imds   Boolean   @default(false)
  non_imds    Boolean   @default(false)
  valid       Boolean   @default(false)
  val_by      String?   @db.VarChar(50)
  val_date    DateTime?
  etic_date   DateTime?
  ins_by      String?   @db.VarChar(50)
  ins_date    DateTime  @default(now())
  chg_by      String?   @db.VarChar(50)
  chg_date    DateTime?

  // Relations
  asset       Asset       @relation(fields: [asset_id], references: [asset_id])
  location    Location?   @relation(fields: [loc_id], references: [loc_id])
  sortie      Sortie?     @relation(fields: [sortie_id], references: [sortie_id])
  repairs     Repair[]
  partsOrders PartsOrder[]
  meters      MeterHist[]
  sruOrders   SruOrder[]
  attachments Attachment[]

  @@map("event")
}

model Repair {
  repair_id     Int       @id @default(autoincrement())
  event_id      Int
  repair_seq    Int       @default(1)
  asset_id      Int?
  start_date    DateTime?
  stop_date     DateTime?
  type_maint    String?   @db.VarChar(10)
  how_mal       String?   @db.VarChar(10)
  when_disc     String?   @db.VarChar(10)
  shop_status   String?   @db.VarChar(20)
  narrative     String?   @db.Text
  tag_no        String?   @db.VarChar(50)
  doc_no        String?   @db.VarChar(50)
  eti_in        Decimal?  @db.Decimal(10, 2)
  eti_out       Decimal?  @db.Decimal(10, 2)
  eti_delta     Decimal?  @db.Decimal(10, 2)
  micap         Boolean   @default(false)
  micap_login   String?   @db.VarChar(50)
  damage        String?   @db.VarChar(100)
  chief_review  Boolean   @default(false)
  super_review  Boolean   @default(false)
  eti_change    Boolean   @default(false)
  repeat_recur  Boolean   @default(false)
  sent_imds     Boolean   @default(false)
  valid         Boolean   @default(false)
  val_by        String?   @db.VarChar(50)
  val_date      DateTime?
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  event       Event             @relation(fields: [event_id], references: [event_id], onDelete: Cascade)
  asset       Asset?            @relation(fields: [asset_id], references: [asset_id])
  labors      Labor[]
  partsOrders PartsOrder[]
  meters      MeterHist[]
  inspections AssetInspection[]
  tctoAssets  TctoAsset[]
  sruOrders   SruOrder[]
  attachments Attachment[]

  @@map("repair")
}

model Labor {
  labor_id     Int       @id @default(autoincrement())
  repair_id    Int
  labor_seq    Int       @default(1)
  asset_id     Int?
  action_taken String?   @db.VarChar(10)
  how_mal      String?   @db.VarChar(10)
  when_disc    String?   @db.VarChar(10)
  type_maint   String?   @db.VarChar(10)
  cat_labor    String?   @db.VarChar(10)
  start_date   DateTime?
  stop_date    DateTime?
  hours        Decimal?  @db.Decimal(5, 2)
  crew_chief   String?   @db.VarChar(50)
  crew_size    Int?
  corrective   String?   @db.Text
  discrepancy  String?   @db.Text
  remarks      String?   @db.Text
  corrected_by String?   @db.VarChar(50)
  inspected_by String?   @db.VarChar(50)
  bit_log      String?   @db.Text
  sent_imds    Boolean   @default(false)
  valid        Boolean   @default(false)
  val_by       String?   @db.VarChar(50)
  val_date     DateTime?
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())
  chg_by       String?   @db.VarChar(50)
  chg_date     DateTime?

  // Relations
  repair     Repair       @relation(fields: [repair_id], references: [repair_id], onDelete: Cascade)
  asset      Asset?       @relation(fields: [asset_id], references: [asset_id])
  laborParts LaborPart[]
  partsOrders PartsOrder[]
  substituteOrders PartsOrder[] @relation("SubstitutePart")
  laborBitPc LaborBitPc[]
  meters     MeterHist[]

  @@map("labor")
}

model LaborPart {
  labor_part_id Int       @id @default(autoincrement())
  labor_id      Int
  asset_id      Int?
  partno_id     Int?
  part_action   String?   @db.VarChar(20)
  how_mal       String?   @db.VarChar(10)
  is_pqdr       Boolean   @default(false)
  dr_num        String?   @db.VarChar(50)
  qty           Int       @default(1)
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  labor Labor     @relation(fields: [labor_id], references: [labor_id], onDelete: Cascade)
  asset Asset?    @relation(fields: [asset_id], references: [asset_id])
  part  PartList? @relation(fields: [partno_id], references: [partno_id])

  @@map("labor_part")
}

model LaborBitPc {
  labor_bit_id Int       @id @default(autoincrement())
  labor_id     Int
  bit_partno   String?   @db.VarChar(50)
  bit_name     String?   @db.VarChar(100)
  bit_seq      Int?
  bit_wuc      String?   @db.VarChar(10)
  how_mal      String?   @db.VarChar(10)
  bit_qty      Int?
  fsc          String?   @db.VarChar(10)
  bit_delete   Boolean   @default(false)
  valid        Boolean   @default(false)
  val_by       String?   @db.VarChar(50)
  val_date     DateTime?
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())

  // Relations
  labor Labor @relation(fields: [labor_id], references: [labor_id], onDelete: Cascade)

  @@map("labor_bit_pc")
}

// ============================================================================
// Inspection & Meter Tables
// ============================================================================

model AssetInspection {
  hist_id       Int       @id @default(autoincrement())
  asset_id      Int
  repair_id     Int?
  wuc_cd        String?   @db.VarChar(10)
  jst_id        Int?
  pmi_type      String?   @db.VarChar(20)
  complete_date DateTime?
  next_due_date DateTime?
  completed_etm Decimal?  @db.Decimal(10, 2)
  next_due_etm  Decimal?  @db.Decimal(10, 2)
  job_no        String?   @db.VarChar(20)
  completed_by  String?   @db.VarChar(50)
  valid         Boolean   @default(false)
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  asset  Asset   @relation(fields: [asset_id], references: [asset_id])
  repair Repair? @relation(fields: [repair_id], references: [repair_id])

  @@map("asset_inspection")
}

model MeterHist {
  meter_id     Int       @id @default(autoincrement())
  asset_id     Int
  repair_id    Int?
  labor_id     Int?
  event_id     Int?
  meter_type   String?   @db.VarChar(20)
  meter_action String?   @db.VarChar(20)
  meter_in     Decimal?  @db.Decimal(10, 2)
  meter_out    Decimal?  @db.Decimal(10, 2)
  changed      Boolean   @default(false)
  failure      Boolean   @default(false)
  seq_num      Int?
  remarks      String?   @db.Text
  valid        Boolean   @default(false)
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())
  chg_by       String?   @db.VarChar(50)
  chg_date     DateTime?

  // Relations
  asset  Asset   @relation(fields: [asset_id], references: [asset_id])
  repair Repair? @relation(fields: [repair_id], references: [repair_id])
  labor  Labor?  @relation(fields: [labor_id], references: [labor_id])
  event  Event?  @relation(fields: [event_id], references: [event_id])

  @@map("meter_hist")
}

model CfgMeter {
  meter_id    Int       @id @default(autoincrement())
  cfg_set_id  Int
  meter_type  String?   @db.VarChar(20)
  meter_value Decimal?  @db.Decimal(10, 2)
  ins_by      String?   @db.VarChar(50)
  ins_date    DateTime  @default(now())
  chg_by      String?   @db.VarChar(50)
  chg_date    DateTime?

  // Relations
  cfgSet CfgSet @relation(fields: [cfg_set_id], references: [cfg_set_id], onDelete: Cascade)

  @@map("cfg_meters")
}

// ============================================================================
// Software Tables
// ============================================================================

model Software {
  sw_id         Int       @id @default(autoincrement())
  sw_number     String    @db.VarChar(50)
  sw_type       String?   @db.VarChar(20)
  sys_id        Int?
  revision      String?   @db.VarChar(20)
  revision_date DateTime?
  sw_title      String?   @db.VarChar(100)
  sw_desc       String?   @db.Text
  eff_date      DateTime?
  cpin_flag     Boolean   @default(false)
  active        Boolean   @default(true)
  valid         Boolean   @default(false)
  val_by        String?   @db.VarChar(50)
  val_date      DateTime?
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  softwareAssets SoftwareAsset[]

  @@map("software")
}

model SoftwareAsset {
  sw_asset_id Int      @id @default(autoincrement())
  asset_id    Int
  sw_id       Int
  eff_date    DateTime?
  ins_by      String?  @db.VarChar(50)
  ins_date    DateTime @default(now())

  // Relations
  asset    Asset    @relation(fields: [asset_id], references: [asset_id], onDelete: Cascade)
  software Software @relation(fields: [sw_id], references: [sw_id])

  @@unique([asset_id, sw_id])
  @@map("software_asset")
}

// ============================================================================
// Sortie Tables
// ============================================================================

model Sortie {
  sortie_id       Int       @id @default(autoincrement())
  pgm_id          Int
  asset_id        Int?
  mission_id      String?   @db.VarChar(50)
  serno           String?   @db.VarChar(50)
  ac_tailno       String?   @db.VarChar(20)
  sortie_date     DateTime?
  sortie_effect   String?   @db.VarChar(10)
  ac_station      String?   @db.VarChar(20)
  ac_type         String?   @db.VarChar(20)
  current_unit    String?   @db.VarChar(20)
  assigned_unit   String?   @db.VarChar(20)
  range           String?   @db.VarChar(20)
  reason          String?   @db.VarChar(100)
  remarks         String?   @db.Text
  source_data     String?   @db.VarChar(50)
  is_non_podded   Boolean   @default(false)
  is_debrief      Boolean   @default(false)
  is_live_monitor Boolean   @default(false)
  valid           Boolean   @default(false)
  val_by          String?   @db.VarChar(50)
  val_date        DateTime?
  ins_by          String?   @db.VarChar(50)
  ins_date        DateTime  @default(now())
  chg_by          String?   @db.VarChar(50)
  chg_date        DateTime?

  // Relations
  program Program @relation(fields: [pgm_id], references: [pgm_id])
  asset   Asset?  @relation(fields: [asset_id], references: [asset_id])
  events  Event[]

  @@map("sorties")
}

// ============================================================================
// TCTO Tables
// ============================================================================

model Tcto {
  tcto_id       Int       @id @default(autoincrement())
  pgm_id        Int
  tcto_no       String    @db.VarChar(50)
  tcto_type     String?   @db.VarChar(20)
  tcto_code     String?   @db.VarChar(20)
  wuc_cd        String?   @db.VarChar(10)
  sys_type      String?   @db.VarChar(20)
  station_type  String?   @db.VarChar(20)
  old_partno_id Int?
  new_partno_id Int?
  eff_date      DateTime?
  remarks       String?   @db.Text
  active        Boolean   @default(true)
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  program    Program     @relation(fields: [pgm_id], references: [pgm_id])
  tctoAssets TctoAsset[]

  @@unique([tcto_no, pgm_id])
  @@map("tcto")
}

model TctoAsset {
  tcto_asset_id Int       @id @default(autoincrement())
  tcto_id       Int
  asset_id      Int
  repair_id     Int?
  complete_date DateTime?
  remarks       String?   @db.Text
  valid         Boolean   @default(false)
  val_by        String?   @db.VarChar(50)
  val_date      DateTime?
  ins_by        String?   @db.VarChar(50)
  ins_date      DateTime  @default(now())
  chg_by        String?   @db.VarChar(50)
  chg_date      DateTime?

  // Relations
  tcto   Tcto    @relation(fields: [tcto_id], references: [tcto_id], onDelete: Cascade)
  asset  Asset   @relation(fields: [asset_id], references: [asset_id])
  repair Repair? @relation(fields: [repair_id], references: [repair_id])

  @@unique([tcto_id, asset_id])
  @@map("tcto_asset")
}

// ============================================================================
// Parts Ordering Tables
// ============================================================================

model SruOrder {
  order_id          Int       @id @default(autoincrement())
  event_id          Int?
  repair_id         Int?
  partno_id         Int?
  asset_id          Int?
  loc_id            Int?
  sru_id            String?   @db.VarChar(50)
  doc_no            String?   @db.VarChar(50)
  order_date        DateTime?
  order_qty         Int       @default(1)
  status            String    @default("REQUEST") @db.VarChar(20)
  micap             Boolean   @default(false)
  delivery_dest     String?   @db.VarChar(100)
  delivery_priority String?   @db.VarChar(20)
  ujc               String?   @db.VarChar(20)
  acknowledge_date  DateTime?
  fill_date         DateTime?
  repl_sru_ship_date DateTime?
  repl_sru_recv_date DateTime?
  shipper           String?   @db.VarChar(50)
  tcn               String?   @db.VarChar(50)
  rem_shipper       String?   @db.VarChar(50)
  rem_tcn           String?   @db.VarChar(50)
  rem_sru_ship_date DateTime?
  receiver          String?   @db.VarChar(50)
  receive_qty       Int?
  receive_date      DateTime?
  esd               DateTime?
  wuc_cd            String?   @db.VarChar(10)
  remarks           String?   @db.Text
  active            Boolean   @default(true)
  ins_by            String?   @db.VarChar(50)
  ins_date          DateTime  @default(now())
  chg_by            String?   @db.VarChar(50)
  chg_date          DateTime?

  // Relations
  event    Event?    @relation(fields: [event_id], references: [event_id])
  repair   Repair?   @relation(fields: [repair_id], references: [repair_id])
  part     PartList? @relation(fields: [partno_id], references: [partno_id])
  asset    Asset?    @relation(fields: [asset_id], references: [asset_id])
  location Location? @relation(fields: [loc_id], references: [loc_id])

  @@map("sru_order")
}

model BadActor {
  bad_actor_id       Int       @id @default(autoincrement())
  loc_id             Int?
  sys_id             Int?
  status_period      Int?
  status_period_type String?   @db.VarChar(20)
  status_count       Int?
  status_cd          String?   @db.VarChar(10)
  multi_ac           Boolean   @default(false)
  active             Boolean   @default(true)
  ins_by             String?   @db.VarChar(50)
  ins_date           DateTime  @default(now())
  chg_by             String?   @db.VarChar(50)
  chg_date           DateTime?

  // Relations
  location Location? @relation(fields: [loc_id], references: [loc_id])

  @@map("bad_actor")
}

// ============================================================================
// Attachment Tables
// ============================================================================

model Attachment {
  attachment_id   Int      @id @default(autoincrement())
  event_id        Int?
  repair_id       Int?
  attachment_name String   @db.VarChar(255)
  attachment_type String?  @db.VarChar(50)
  file_path       String   @db.VarChar(500)
  file_size       Int?
  mime_type       String?  @db.VarChar(100)
  ins_by          String?  @db.VarChar(50)
  ins_date        DateTime @default(now())

  // Relations
  event  Event?  @relation(fields: [event_id], references: [event_id], onDelete: Cascade)
  repair Repair? @relation(fields: [repair_id], references: [repair_id], onDelete: Cascade)

  @@map("attachments")
}

// ============================================================================
// Notification & System Tables
// ============================================================================

model Notification {
  msg_id       Int       @id @default(autoincrement())
  pgm_id       Int?
  loc_id       Int?
  msg_text     String    @db.Text
  priority     String?   @db.VarChar(20)
  start_date   DateTime?
  stop_date    DateTime?
  from_user    String?   @db.VarChar(50)
  to_user      String?   @db.VarChar(50)
  acknowledged Boolean   @default(false)
  ack_by       String?   @db.VarChar(50)
  ack_date     DateTime?
  active       Boolean   @default(true)
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())

  // Relations
  program  Program?  @relation(fields: [pgm_id], references: [pgm_id])
  location Location? @relation(fields: [loc_id], references: [loc_id])

  @@map("notification")
}

model AuditLog {
  log_id     Int      @id @default(autoincrement())
  user_id    Int?
  action     String   @db.VarChar(20)
  table_name String   @db.VarChar(50)
  record_id  Int?
  old_values Json?
  new_values Json?
  ip_address String?  @db.VarChar(45)
  created_at DateTime @default(now())

  // Relations
  user User? @relation(fields: [user_id], references: [user_id])

  @@map("audit_log")
}

model AdmVariable {
  var_id    Int       @id @default(autoincrement())
  var_name  String    @unique @db.VarChar(50)
  var_value String?   @db.Text
  var_desc  String?   @db.VarChar(255)
  active    Boolean   @default(true)
  ins_by    String?   @db.VarChar(50)
  ins_date  DateTime  @default(now())
  chg_by    String?   @db.VarChar(50)
  chg_date  DateTime?

  @@map("adm_variable")
}

// ============================================================================
// Spares Inventory Tables
// ============================================================================

model Spare {
  spare_id     Int       @id @default(autoincrement())
  pgm_id       Int
  partno       String    @db.VarChar(50)
  serno        String    @db.VarChar(50)
  status       String    @default("AVAILABLE") @db.VarChar(20)
  loc_id       Int?
  warranty_exp DateTime?
  mfg_date     DateTime?
  unit_price   Decimal?  @db.Decimal(12, 2)
  remarks      String?   @db.Text
  active       Boolean   @default(true)
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())
  chg_by       String?   @db.VarChar(50)
  chg_date     DateTime?

  // Relations
  program  Program   @relation(fields: [pgm_id], references: [pgm_id])
  location Location? @relation(fields: [loc_id], references: [loc_id])

  @@unique([partno, serno])
  @@map("spares")
}

// ============================================================================
// Location Set Tables
// ============================================================================

model LocSet {
  set_id       Int       @id @default(autoincrement())
  set_name     String    @db.VarChar(100)
  pgm_id       Int
  loc_id       Int
  display_name String?   @db.VarChar(255)
  active       Boolean   @default(true)
  ins_by       String?   @db.VarChar(50)
  ins_date     DateTime  @default(now())
  chg_by       String?   @db.VarChar(50)
  chg_date     DateTime?

  // Relations
  program  Program  @relation(fields: [pgm_id], references: [pgm_id])
  location Location @relation(fields: [loc_id], references: [loc_id])

  @@unique([set_name, loc_id])
  @@map("loc_set")
}

// ============================================================================
// Parts Ordering Tables
// ============================================================================

model PartsOrder {
  order_id          Int       @id @default(autoincrement())
  order_no          String    @unique @db.VarChar(50)
  partno_id         Int
  quantity          Int
  quantity_received Int?
  status            String    @default("REQUESTED") @db.VarChar(20) // REQUESTED, APPROVED, ORDERED, RECEIVED, ISSUED, CANCELLED
  priority          String    @default("ROUTINE") @db.VarChar(20)   // ROUTINE, URGENT, MICAP
  
  // Associations
  event_id          Int?
  repair_id         Int?
  loc_id            Int
  substitute_partno_id Int?
  
  // Workflow tracking
  requested_by      String    @db.VarChar(50)
  requested_date    DateTime  @default(now())
  approved_by       String?   @db.VarChar(50)
  approved_date     DateTime?
  ordered_by        String?   @db.VarChar(50)
  ordered_date      DateTime?
  received_by       String?   @db.VarChar(50)
  received_date     DateTime?
  issued_to         String?   @db.VarChar(50)
  issued_by         String?   @db.VarChar(50)
  issued_date       DateTime?
  cancelled_by      String?   @db.VarChar(50)
  cancelled_date    DateTime?
  cancel_reason     String?   @db.Text
  
  // Vendor info
  vendor_name       String?   @db.VarChar(100)
  vendor_order_no   String?   @db.VarChar(50)
  expected_date     DateTime?
  unit_cost         Decimal?  @db.Decimal(12, 2)
  tcn               String?   @db.VarChar(50) // Transportation Control Number
  
  // Metadata
  current_stock     Int?      // Stock level at time of request
  notes             String?   @db.Text
  ins_by            String?   @db.VarChar(50)
  ins_date          DateTime  @default(now())
  chg_by            String?   @db.VarChar(50)
  chg_date          DateTime?

  // Relations
  part              PartList  @relation(fields: [partno_id], references: [partno_id])
  location          Location  @relation("PartsOrderLocation", fields: [loc_id], references: [loc_id])
  event             Event?    @relation(fields: [event_id], references: [event_id])
  repair            Repair?   @relation(fields: [repair_id], references: [repair_id])
  substitutePart    PartList? @relation("SubstitutePart", fields: [substitute_partno_id], references: [partno_id])
  history           PartsOrderHistory[]

  @@index([loc_id, status])
  @@index([repair_id])
  @@index([partno_id])
  @@map("parts_order")
}

model PartsOrderHistory {
  history_id   Int       @id @default(autoincrement())
  order_id     Int
  status       String    @db.VarChar(20)
  changed_by   String    @db.VarChar(50)
  notes        String?   @db.Text
  created_at   DateTime  @default(now())

  // Relations
  order        PartsOrder @relation(fields: [order_id], references: [order_id], onDelete: Cascade)

  @@index([order_id])
  @@map("parts_order_history")
}
