<!DOCTYPE html>
<html>
<head>
  <title>Test Meter History</title>
</head>
<body>
  <h1>Creating Test Asset with Meter History...</h1>
  <div id="log"></div>

  <script type="module">
    const API_BASE = 'http://localhost:3001/api';

    // Login
    async function login() {
      const response = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: 'admin', password: 'admin123' })
      });
      const data = await response.json();
      return data.token;
    }

    function log(msg) {
      document.getElementById('log').innerHTML += `<p>${msg}</p>`;
      console.log(msg);
    }

    async function createTestAsset() {
      try {
        log('Logging in...');
        const token = await login();
        log('Logged in successfully');

        // Create a maintenance event first (for asset TEST-PMI-HEATMAP-001)
        log('Creating maintenance event with meter readings...');

        const eventResponse = await fetch(`${API_BASE}/events`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            asset_id: 907793,
            job_no: 'MX-METER-TEST-243-001',
            discrepancy: 'Test maintenance for meter history verification - feature #243',
            start_job: new Date().toISOString(),
            event_type: 'Standard',
            priority: 'Routine',
            status: 'open'
          })
        });

        const event = await eventResponse.json();
        log(`Created event: ${event.job_no} (ID: ${event.event_id})`);

        // Create a repair with ETI meter readings
        log('Creating repair with ETI meter readings...');

        const repairResponse = await fetch(`${API_BASE}/repairs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            event_id: event.event_id,
            asset_id: 907793,
            start_date: new Date().toISOString(),
            type_maint: 'Scheduled',
            shop_status: 'open',
            eti_in: 0,
            eti_out: 50,
            eti_delta: 50,
            narrative: 'Test repair with ETI meter readings to verify feature #243 - ETM meter history tracking'
          })
        });

        const repair = await repairResponse.json();
        log(`Created repair with ETI In: ${repair.eti_in}, ETI Out: ${repair.eti_out}, Delta: ${repair.eti_delta}`);

        // Close the repair
        log('Closing repair...');
        await fetch(`${API_BASE}/repairs/${repair.repair_id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            ...repair,
            shop_status: 'closed',
            stop_date: new Date().toISOString()
          })
        });

        // Close the event
        log('Closing event...');
        await fetch(`${API_BASE}/events/${event.event_id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            ...event,
            status: 'closed',
            stop_job: new Date().toISOString()
          })
        });

        log('<br><strong style="color: green;">âœ… SUCCESS!</strong>');
        log(`<br>Meter history created for asset TEST-PMI-HEATMAP-001`);
        log(`<br>View at: <a href="http://localhost:5173/assets/907793?tab=meters" target="_blank">http://localhost:5173/assets/907793?tab=meters</a>`);

      } catch (error) {
        log(`<br><strong style="color: red;">Error:</strong> ${error.message}`);
      }
    }

    createTestAsset();
  </script>
</body>
</html>
